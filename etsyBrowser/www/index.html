<!DOCTYPE html>
<html>
  <head>
  <title></title>
  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
	<meta charset="utf-8">


	<!-- iPad/iPhone specific css below, add after your main css >
	<link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="ipad.css" type="text/css" />		
	<link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="iphone.css" type="text/css" />		
	-->
	<!-- If your application is targeting iOS BEFORE 4.0 you MUST put json2.js from http://www.JSON.org/json2.js into your www directory and include it here -->
		<script type="text/javascript" charset="utf-8" src="oauth.js"></script>
			<script type="text/javascript" charset="utf-8" src="sha1.js"></script>

	<script type="text/javascript" charset="utf-8" src="ChildBrowser.js"></script>
	<script type="text/javascript" charset="utf-8" src="cordova-1.5.0.js"></script>
					<script type="text/javascript" charset="utf-8" src="EmailComposer.js"></script>
    <script type="text/javascript">

		var GLOBAL = {
		  version: '1.0'
		};


	// If you want to prevent dragging, uncomment this section
	/*
	function preventBehavior(e) 
	{ 
      e.preventDefault(); 
    };
	document.addEventListener("touchmove", preventBehavior, false);
	*/
	
	/* If you are supporting your own protocol, the var invokeString will contain any arguments to the app launch.
	see http://iphonedevelopertips.com/cocoa/launching-your-own-application-via-a-custom-url-scheme.html
	for more details -jm */
	/*
	function handleOpenURL(url)
	{
		// TODO: do something with the url passed in.
	}
	*/
	
	function onBodyLoad() 
	{		
		document.addEventListener("deviceready", onDeviceReady, false);
		console.log('in onBodyLoad');
		//initializeCart();
		
	}
	
	/* When this function is called, Cordova has been initialized and is ready to roll */
	/* If you are supporting your own protocol, the var invokeString will contain any arguments to the app launch.
	see http://iphonedevelopertips.com/cocoa/launching-your-own-application-via-a-custom-url-scheme.html
	for more details -jm */
	function onDeviceReady()
	{
		// do your thing!
    // navigator.notification.alert("Cordova is working")

		var cb = ChildBrowser.install();
		
		cb.onLocationChange = function(loc){ 
			console.log('******** location' + loc);
			locChanged(loc); 
		};

		
	}

	function initializeCart(){
		console.log('in initialize cart');
		var options = { 
	            consumerKey: 'tia49fh9iqjcrukurpbyqtv5',
	            consumerSecret: '2dvoqadnxo'
		};
		
		// Check for access token key/secret in localStorage
	    var storedAccessData, rawData = localStorage.getItem('token');

    storedAccessData = JSON.parse(rawData);                 
    options.accessTokenKey = storedAccessData.accessTokenKey;
    options.accessTokenSecret = storedAccessData.accessTokenSecret;

    console.log("AppLaudLog: Attemping oauth with stored token key/secret");           
    oauth = OAuth(options);
    oauth.get('http://openapi.etsy.com/v2/users/__SELF__/carts',
			 function(data) {
				var info = JSON.parse(data.text);
				var results = info.results;
				console.log('info is', info);
					var cart = "Cart items:<br/></br>";
					for(i=0; i< results.length; i++){
						cart = cart + results[i].shop_name + '<br/>'
					}
					Ext.getCmp('cartContent').setHtml(cart);
				},
				 function(data) {
					}
				);
	}
	
	function locChanged(loc){
    
    // The supplied oauth_callback_url for this session is being loaded
    if (loc.indexOf("http://www.etsy.com/?") >= 0) {
        completeAuthorization(loc);
    }
	}
	
	
	function completeAuthorization(loc){
		var index, verifier = '';            
    var params = loc.substr(loc.indexOf('?') + 1);
    var parsedParams = $.deparam(params);
		console.log('params are', parsedParams);

		var oauth;
 
		var options = { 
          consumerKey: 'tia49fh9iqjcrukurpbyqtv5',
          consumerSecret: '2dvoqadnxo',
					accessTokenKey: parsedParams.oauth_token,
					accessTokenSecret: GLOBAL.params.oauth_token_secret
 		};

		oauth = OAuth(options);
		verifier = parsedParams.oauth_verifier;

		  
		// Exchange request token for access token
		var url = 'http://openapi.etsy.com/v2/oauth/access_token?oauth_verifier=' + verifier;
		console.log('URL IS\n\n\n' + url)
      oauth.get(url,
                function(data) {    
   									console.log('data is ********' +  data);
                    var accessParams = {};
                    var qvars_tmp = data.text.split('&');
                    for (var i = 0; i < qvars_tmp.length; i++) {
                        var y = qvars_tmp[i].split('=');
                        accessParams[y[0]] = decodeURIComponent(y[1]);
                    }
                    console.log('AppLaudLog: ' + accessParams.oauth_token + ' : ' + accessParams.oauth_token_secret);
                    // $('#oauthStatus').html('<span style="color:green;">Success!</span>');
                    // $('#stage-auth').hide();
                    // $('#stage-data').show();
                    oauth.setAccessToken([accessParams.oauth_token, accessParams.oauth_token_secret]);
                    
                    // Save access token/key in localStorage
                    var accessData = {};
                    accessData.accessTokenKey = accessParams.oauth_token;
                    accessData.accessTokenSecret = accessParams.oauth_token_secret;
                    console.log("AppLaudLog: \n\n\n\n\n" + JSON.stringify(accessData));
                    localStorage.setItem('tokens', JSON.stringify(accessData));

										// oauth.get('http://openapi.etsy.com/v2/users/__SELF__',
										// 										function(data) {    
										// 												var info = JSON.parse(data.text);
										// 												navigator.notification.alert('Hi ' + info.results[0].login_name);
										// 												console.log(info);
										// 										},
										// 										function(data) { 
										// 											console.log('error data',data);
										// 										});
										
										Ext.getCmp('favoritesPanelLoginButton').hide();
										
										Ext.getCmp('cartPanelSignInButton').hide();
										Ext.getCmp('cartPanelSignOutButton').show();
										
                    // oauth.get('https://api.twitter.com/1/account/verify_credentials.json?skip_status=true',
                    //         function(data) {
                    //             var entry = JSON.parse(data.text);
                    //             $('#userInfo').html('Current user: <strong>' + entry.screen_name + '</strong>');
                    //             console.log("AppLaudLog: screen_name: " + entry.screen_name);
                    //         },
                    //         function(data) { 
                    //             alert('Error getting user credentials'); 
                    //             console.log("AppLaudLog: Error " + data); 
                    //             $('#oauthStatus').html('<span style="color:red;">Error getting user credentials</span>');
                    //         }
                    // );                                         
                    window.plugins.childBrowser.close();
            },
            function(data) { 
								console.log('\n\n\n\n\n\n\n\n\n\n');

                console.log('ERROR: \n\n' +  data.text); 
                $('#oauthStatus').html('<span style="color:red;">Error during authorization</span>');
            }
        );
	}
	  
    </script>
    
    <!-- GT ADDED -->
		<script src="jquery.js"></script>
		<script src="jquery.bbq.js"></script>

    <link rel="stylesheet" type="text/css" href="resources/css/sencha-touch.css?1"/>
    <script type="text/javascript" src="sencha-touch-all-debug.js"></script>
    <script type="text/javascript" src="etsy.js"></script>
    <link rel="stylesheet" type="text/css" href="resources/css/application.css?2"/>

  </head>
  <body onload="onBodyLoad()">
  </body>
</html>
